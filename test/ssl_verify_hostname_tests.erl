%%% -*- erlang -*-
%%%
%%% MIT License
%%%
%%% Copyright (c) 2014, Ilya Khaprov <ilya.khaprov@publitechs.com>

-module(ssl_verify_hostname_tests).

-include_lib("eunit/include/eunit.hrl").

verify_hostname_success_test_ () ->
           %% presented identifier, reference identifier, validation and parsing result
  Tests = [
           {"www.example.com", "WWW.eXamPle.CoM", false}, %% case insensitive match
           {"www.example.com.", "www.example.com", false}, %% ignore trailing dots (prevenet *.com. matches)
           {"www.example.com", "www.example.com.", false},
           {"*.example.com", "www.example.com", {[], ".example.com", true}},         %% always matching wildcards
           {"b*z.example.com", "buzz.example.com", {"b", "z.example.com", false}},
           {"*baz.example.com", "foobaz.example.com", {[], "baz.example.com", false}},
           {"baz*.example.com", "baz1.example.com", {"baz", ".example.com", false}}
          ],
  [{string:join([I, R]," : "), fun() ->
                                   ?assertMatch(V, ssl_verify_hostname:validate_and_parse_wildcard_identifier(I, R)),
                                   ?assert(ssl_verify_hostname:try_match_hostname(I, R))
                               end} || {I, R, V} <- Tests].


verify_hostname_fail_test_ () ->
           %% presented identifier, reference identifier
  Tests = [
           {"*.com", "eXamPle.CoM"},
           {".com.", "example.com."},
           {"*.www.example.com", "www.example.com."},
           {"foo.*.example.com", "foo.bar.example.com."},
           {"xn--*.example.com", "xn-foobar.example.com"},
           {"*fooxn--bar.example.com", "bazfooxn--bar.example.com"},
           {"*.akamaized.net", "tv.eurosport.com"},
           {"a*c.example.com", "abcd.example.com"},
           {"*baz.example.com", "foobuzz.example.com"}
          ],
  [{string:join([I, R]," : "), fun() -> ?assertNot(ssl_verify_hostname:try_match_hostname(I, R)) end} || {I, R} <- Tests].

% actual cert content dumped via:
% ssl:connect("google.co.uk", 443, [{verify_fun, {fun(C, E, State) -> io:format(user, "C: ~p~n", [C]), {valid, state} end, state}}])
% if you load a cert via a pem then you will get different values. 
% i'm not sure why pem has strings like <<>> and certs via verify have {utf8String, }
% maybe there is a conversion function hiding in OTP that convert {utf8String, XXX} and {YYY, XXX} to strings :)
google_cert() ->
  {'OTPCertificate',
       {'OTPTBSCertificate',v3,6133240561135145997,
           {'SignatureAlgorithm',{1,2,840,113549,1,1,5},'NULL'},
           {rdnSequence,
               [[{'AttributeTypeAndValue',{2,5,4,6},"US"}],
                [{'AttributeTypeAndValue',
                     {2,5,4,10},
                     {printableString,"Google Inc"}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,3},
                     {printableString,"Google Internet Authority G2"}}]]},
           {'Validity',{utcTime,"150227200232Z"},{utcTime,"150528000000Z"}},
           {rdnSequence,
               [[{'AttributeTypeAndValue',{2,5,4,6},"US"}],
                [{'AttributeTypeAndValue',
                     {2,5,4,8},
                     {utf8String,<<"California">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,7},
                     {utf8String,<<"Mountain View">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,10},
                     {utf8String,<<"Google Inc">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,3},
                     {utf8String,<<"*.google.co.uk">>}}]]},
           {'OTPSubjectPublicKeyInfo',
               {'PublicKeyAlgorithm',{1,2,840,113549,1,1,1},'NULL'},
               {'RSAPublicKey',
                   21927250826865278775895611703533232243693535525962833119238150236398731034895955331644039133501852173334554161771648440932291804376770549068614484079388502242244123075828190609709882016707031152947703167780098802188237289668048162649531839125466087579825738933013684131113050572815726659983646315186571605286780325445956984030548157201601106170835748559482991684890602746172933961122381912090819531220323444108751546574721015534262929282499817491085870578960861471075311489946823688889302205952206739606192790517241210323813855256101996193368771712701531647807098915928864078348267899450062698717113553740417663414977,
                   65537}},
           asn1_NOVALUE,asn1_NOVALUE,
           [{'Extension',
                {2,5,29,37},
                false,
                [{1,3,6,1,5,5,7,3,1},{1,3,6,1,5,5,7,3,2}]},
            {'Extension',
                {2,5,29,17},
                false,
                [{dNSName,"*.google.co.uk"},{dNSName,"google.co.uk"}]},
            {'Extension',
                {1,3,6,1,5,5,7,1,1},
                false,
                [{'AccessDescription',
                     {1,3,6,1,5,5,7,48,2},
                     {uniformResourceIdentifier,
                         "http://pki.google.com/GIAG2.crt"}},
                 {'AccessDescription',
                     {1,3,6,1,5,5,7,48,1},
                     {uniformResourceIdentifier,
                         "http://clients1.google.com/ocsp"}}]},
            {'Extension',
                {2,5,29,14},
                false,
                [2,235,98,39,187,181,91,148,194,18,30,33,128,151,90,220,203,
                 222,18,185]},
            {'Extension',
                {2,5,29,19},
                true,
                {'BasicConstraints',false,asn1_NOVALUE}},
            {'Extension',
                {2,5,29,35},
                false,
                {'AuthorityKeyIdentifier',
                    [74,221,6,22,27,188,246,104,181,118,245,129,182,187,98,26,
                     186,90,129,47],
                    asn1_NOVALUE,asn1_NOVALUE}},
            {'Extension',
                {2,5,29,32},
                false,
                [{'PolicyInformation',
                     {1,3,6,1,4,1,11129,2,5,1},
                     asn1_NOVALUE}]},
            {'Extension',
                {2,5,29,31},
                false,
                [{'DistributionPoint',
                     {fullName,
                         [{uniformResourceIdentifier,
                              "http://pki.google.com/GIAG2.crl"}]},
                     asn1_NOVALUE,asn1_NOVALUE}]}]},
       {'SignatureAlgorithm',{1,2,840,113549,1,1,5},'NULL'},
       {0,
        <<54,180,108,33,138,77,161,246,209,177,192,141,55,158,228,242,249,53,
          236,73,201,130,183,61,154,9,133,1,40,224,75,44,167,84,96,179,58,
          180,101,92,255,106,88,141,128,174,134,217,117,69,252,129,225,203,
          86,185,30,97,169,156,211,141,46,216,175,73,209,11,92,15,178,104,
          149,18,50,7,120,206,205,55,133,128,62,137,29,28,14,209,82,173,221,
          194,208,29,43,249,207,4,97,29,123,42,234,69,41,45,204,210,194,70,
          199,237,215,149,188,226,34,136,226,239,232,64,232,195,30,96,80,32,
          85,80,5,9,57,250,142,174,166,59,24,111,188,81,131,27,151,79,207,
          106,36,19,161,79,203,195,125,239,47,60,243,84,33,149,69,20,143,181,
          13,107,158,204,199,103,128,44,144,110,174,29,60,79,49,91,223,160,
          26,40,189,222,105,37,113,81,27,248,112,204,230,119,79,43,46,38,66,
          133,225,54,77,140,205,59,49,11,87,234,98,47,231,66,90,179,211,16,
          69,127,250,253,229,57,236,190,250,64,131,146,30,184,110,129,70,49,
          167,154,77,107,205,121,53,113,168,184,8,135,64,153,134,36>>}}.

google_cert_dns_wildcard() ->
  {'OTPCertificate',
       {'OTPTBSCertificate',v3,6133240561135145997,
           {'SignatureAlgorithm',{1,2,840,113549,1,1,5},'NULL'},
           {rdnSequence,
               [[{'AttributeTypeAndValue',{2,5,4,6},"US"}],
                [{'AttributeTypeAndValue',
                     {2,5,4,10},
                     {printableString,"Google Inc"}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,3},
                     {printableString,"Google Internet Authority G2"}}]]},
           {'Validity',{utcTime,"150227200232Z"},{utcTime,"150528000000Z"}},
           {rdnSequence,
               [[{'AttributeTypeAndValue',{2,5,4,6},"US"}],
                [{'AttributeTypeAndValue',
                     {2,5,4,8},
                     {utf8String,<<"California">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,7},
                     {utf8String,<<"Mountain View">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,10},
                     {utf8String,<<"Google Inc">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,3},
                     {utf8String,<<"*.google.co.uk">>}}]]},
           {'OTPSubjectPublicKeyInfo',
               {'PublicKeyAlgorithm',{1,2,840,113549,1,1,1},'NULL'},
               {'RSAPublicKey',
                   21927250826865278775895611703533232243693535525962833119238150236398731034895955331644039133501852173334554161771648440932291804376770549068614484079388502242244123075828190609709882016707031152947703167780098802188237289668048162649531839125466087579825738933013684131113050572815726659983646315186571605286780325445956984030548157201601106170835748559482991684890602746172933961122381912090819531220323444108751546574721015534262929282499817491085870578960861471075311489946823688889302205952206739606192790517241210323813855256101996193368771712701531647807098915928864078348267899450062698717113553740417663414977,
                   65537}},
           asn1_NOVALUE,asn1_NOVALUE,
           [{'Extension',
                {2,5,29,37},
                false,
                [{1,3,6,1,5,5,7,3,1},{1,3,6,1,5,5,7,3,2}]},
            {'Extension',
                {2,5,29,17},
                false,
                [{dNSName,"*.google.co.uk"}]},
            {'Extension',
                {1,3,6,1,5,5,7,1,1},
                false,
                [{'AccessDescription',
                     {1,3,6,1,5,5,7,48,2},
                     {uniformResourceIdentifier,
                         "http://pki.google.com/GIAG2.crt"}},
                 {'AccessDescription',
                     {1,3,6,1,5,5,7,48,1},
                     {uniformResourceIdentifier,
                         "http://clients1.google.com/ocsp"}}]},
            {'Extension',
                {2,5,29,14},
                false,
                [2,235,98,39,187,181,91,148,194,18,30,33,128,151,90,220,203,
                 222,18,185]},
            {'Extension',
                {2,5,29,19},
                true,
                {'BasicConstraints',false,asn1_NOVALUE}},
            {'Extension',
                {2,5,29,35},
                false,
                {'AuthorityKeyIdentifier',
                    [74,221,6,22,27,188,246,104,181,118,245,129,182,187,98,26,
                     186,90,129,47],
                    asn1_NOVALUE,asn1_NOVALUE}},
            {'Extension',
                {2,5,29,32},
                false,
                [{'PolicyInformation',
                     {1,3,6,1,4,1,11129,2,5,1},
                     asn1_NOVALUE}]},
            {'Extension',
                {2,5,29,31},
                false,
                [{'DistributionPoint',
                     {fullName,
                         [{uniformResourceIdentifier,
                              "http://pki.google.com/GIAG2.crl"}]},
                     asn1_NOVALUE,asn1_NOVALUE}]}]},
       {'SignatureAlgorithm',{1,2,840,113549,1,1,5},'NULL'},
       {0,
        <<54,180,108,33,138,77,161,246,209,177,192,141,55,158,228,242,249,53,
          236,73,201,130,183,61,154,9,133,1,40,224,75,44,167,84,96,179,58,
          180,101,92,255,106,88,141,128,174,134,217,117,69,252,129,225,203,
          86,185,30,97,169,156,211,141,46,216,175,73,209,11,92,15,178,104,
          149,18,50,7,120,206,205,55,133,128,62,137,29,28,14,209,82,173,221,
          194,208,29,43,249,207,4,97,29,123,42,234,69,41,45,204,210,194,70,
          199,237,215,149,188,226,34,136,226,239,232,64,232,195,30,96,80,32,
          85,80,5,9,57,250,142,174,166,59,24,111,188,81,131,27,151,79,207,
          106,36,19,161,79,203,195,125,239,47,60,243,84,33,149,69,20,143,181,
          13,107,158,204,199,103,128,44,144,110,174,29,60,79,49,91,223,160,
          26,40,189,222,105,37,113,81,27,248,112,204,230,119,79,43,46,38,66,
          133,225,54,77,140,205,59,49,11,87,234,98,47,231,66,90,179,211,16,
          69,127,250,253,229,57,236,190,250,64,131,146,30,184,110,129,70,49,
          167,154,77,107,205,121,53,113,168,184,8,135,64,153,134,36>>}}.

google_cert_without_dns() ->
  {'OTPCertificate',
       {'OTPTBSCertificate',v3,6133240561135145997,
           {'SignatureAlgorithm',{1,2,840,113549,1,1,5},'NULL'},
           {rdnSequence,
               [[{'AttributeTypeAndValue',{2,5,4,6},"US"}],
                [{'AttributeTypeAndValue',
                     {2,5,4,10},
                     {printableString,"Google Inc"}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,3},
                     {printableString,"Google Internet Authority G2"}}]]},
           {'Validity',{utcTime,"150227200232Z"},{utcTime,"150528000000Z"}},
           {rdnSequence,
               [[{'AttributeTypeAndValue',{2,5,4,6},"US"}],
                [{'AttributeTypeAndValue',
                     {2,5,4,8},
                     {utf8String,<<"California">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,7},
                     {utf8String,<<"Mountain View">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,10},
                     {utf8String,<<"Google Inc">>}}],
                [{'AttributeTypeAndValue',
                     {2,5,4,3},
                     {utf8String,<<"*.google.co.uk">>}}]]},
           {'OTPSubjectPublicKeyInfo',
               {'PublicKeyAlgorithm',{1,2,840,113549,1,1,1},'NULL'},
               {'RSAPublicKey',
                   21927250826865278775895611703533232243693535525962833119238150236398731034895955331644039133501852173334554161771648440932291804376770549068614484079388502242244123075828190609709882016707031152947703167780098802188237289668048162649531839125466087579825738933013684131113050572815726659983646315186571605286780325445956984030548157201601106170835748559482991684890602746172933961122381912090819531220323444108751546574721015534262929282499817491085870578960861471075311489946823688889302205952206739606192790517241210323813855256101996193368771712701531647807098915928864078348267899450062698717113553740417663414977,
                   65537}},
           asn1_NOVALUE,asn1_NOVALUE,
           [{'Extension',
                {2,5,29,37},
                false,
                [{1,3,6,1,5,5,7,3,1},{1,3,6,1,5,5,7,3,2}]},
            {'Extension',
                {1,3,6,1,5,5,7,1,1},
                false,
                [{'AccessDescription',
                     {1,3,6,1,5,5,7,48,2},
                     {uniformResourceIdentifier,
                         "http://pki.google.com/GIAG2.crt"}},
                 {'AccessDescription',
                     {1,3,6,1,5,5,7,48,1},
                     {uniformResourceIdentifier,
                         "http://clients1.google.com/ocsp"}}]},
            {'Extension',
                {2,5,29,14},
                false,
                [2,235,98,39,187,181,91,148,194,18,30,33,128,151,90,220,203,
                 222,18,185]},
            {'Extension',
                {2,5,29,19},
                true,
                {'BasicConstraints',false,asn1_NOVALUE}},
            {'Extension',
                {2,5,29,35},
                false,
                {'AuthorityKeyIdentifier',
                    [74,221,6,22,27,188,246,104,181,118,245,129,182,187,98,26,
                     186,90,129,47],
                    asn1_NOVALUE,asn1_NOVALUE}},
            {'Extension',
                {2,5,29,32},
                false,
                [{'PolicyInformation',
                     {1,3,6,1,4,1,11129,2,5,1},
                     asn1_NOVALUE}]},
            {'Extension',
                {2,5,29,31},
                false,
                [{'DistributionPoint',
                     {fullName,
                         [{uniformResourceIdentifier,
                              "http://pki.google.com/GIAG2.crl"}]},
                     asn1_NOVALUE,asn1_NOVALUE}]}]},
       {'SignatureAlgorithm',{1,2,840,113549,1,1,5},'NULL'},
       {0,
        <<54,180,108,33,138,77,161,246,209,177,192,141,55,158,228,242,249,53,
          236,73,201,130,183,61,154,9,133,1,40,224,75,44,167,84,96,179,58,
          180,101,92,255,106,88,141,128,174,134,217,117,69,252,129,225,203,
          86,185,30,97,169,156,211,141,46,216,175,73,209,11,92,15,178,104,
          149,18,50,7,120,206,205,55,133,128,62,137,29,28,14,209,82,173,221,
          194,208,29,43,249,207,4,97,29,123,42,234,69,41,45,204,210,194,70,
          199,237,215,149,188,226,34,136,226,239,232,64,232,195,30,96,80,32,
          85,80,5,9,57,250,142,174,166,59,24,111,188,81,131,27,151,79,207,
          106,36,19,161,79,203,195,125,239,47,60,243,84,33,149,69,20,143,181,
          13,107,158,204,199,103,128,44,144,110,174,29,60,79,49,91,223,160,
          26,40,189,222,105,37,113,81,27,248,112,204,230,119,79,43,46,38,66,
          133,225,54,77,140,205,59,49,11,87,234,98,47,231,66,90,179,211,16,
          69,127,250,253,229,57,236,190,250,64,131,146,30,184,110,129,70,49,
          167,154,77,107,205,121,53,113,168,184,8,135,64,153,134,36>>}}.


verify_google_cert_test () ->
  ?assertEqual({valid, "google.co.uk"}, ssl_verify_hostname:verify_fun(google_cert(), valid_peer, [{check_hostname, "google.co.uk"}])).

verify_google_cert_dns_wildcard_test () ->
  ?assertEqual({valid, "www.google.co.uk"}, ssl_verify_hostname:verify_fun(google_cert_dns_wildcard(), valid_peer, [{check_hostname, "www.google.co.uk"}])).


verify_google_cert_without_dns_test () ->
  ?assertEqual({valid, "www.google.co.uk"}, ssl_verify_hostname:verify_fun(google_cert_without_dns(), valid_peer, [{check_hostname, "www.google.co.uk"}])).



%%TODO: add certificate tests
